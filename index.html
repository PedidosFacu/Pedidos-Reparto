<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>App Repartidor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        body { background-color: #f0f2f5; padding-bottom: 120px; font-family: -apple-system, sans-serif; }
        
        /* MODO ADMIN (CONFIG): OCULTA CONTROLES DE COMPRA */
        body.admin-mode .qty-control, 
        body.admin-mode .cart-bar,
        body.admin-mode .btn-circle { display: none !important; }

        /* MODO SHOPPING (REPARTIDOR): OCULTA COSAS DE ADMIN */
        body.shopping-mode .admin-panel,
        body.shopping-mode .cart-bar { display: none !important; }
        
        /* En modo shopping, mostramos controles SOLO si estamos buscando (no en la lista checklist) */
        body.shopping-mode .qty-control { display: flex !important; }

        .admin-panel { background: #343a40; color: white; padding: 15px; border-radius: 0 0 15px 15px; margin-bottom: 20px; display: none; }
        .product-card { background: white; border-radius: 12px; padding: 12px; margin-bottom: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .category-label { font-size: 0.7rem; color: #198754; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; }
        .product-name { font-weight: 600; font-size: 0.95rem; color: #212529; line-height: 1.2; margin-bottom: 4px; }
        .product-price-big { font-size: 1.3rem; font-weight: 800; color: #0d6efd; }
        .price-detail-small { font-size: 0.85rem; color: #6c757d; margin-top: 2px; }
        
        /* ESTILOS DEL CHECKLIST (MODO SHOPPING) */
        .shopping-item { cursor: pointer; border-left: 5px solid transparent; }
        .shopping-item.status-done { background-color: #d1e7dd; border-left-color: #198754; opacity: 0.6; }
        .shopping-item.status-done .product-name { text-decoration: line-through; }
        .shopping-item.status-issue { background-color: #fff3cd; border-left-color: #ffc107; }
        .status-icon { font-size: 1.5rem; margin-right: 10px; min-width: 30px; text-align: center; }
        
        /* Boton eliminar en modo shopping */
        .btn-trash-shop { background: none; border: none; color: #dc3545; font-size: 1.2rem; padding: 0 10px; z-index: 10; }

        .qty-control { display: flex; align-items: center; gap: 5px; }
        .btn-circle { width: 32px; height: 32px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; padding: 0; cursor: pointer; }
        .btn-minus { background: #e9ecef; color: #dc3545; }
        .btn-plus { background: #0d6efd; color: white; }
        .qty-input { width: 40px; text-align: center; border: 1px solid #dee2e6; border-radius: 5px; font-weight: bold; }
        
        .cart-bar { position: fixed; bottom: 20px; left: 5%; width: 90%; background: #212529; color: white; border-radius: 50px; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 2000; transition: transform 0.3s; cursor: pointer; transform: translateY(150%); }
        .cart-bar.visible { transform: translateY(0); }
        .btn-ver-pedido { background: #ffc107; color: #212529; border: none; padding: 8px 20px; border-radius: 20px; font-weight: bold; display: flex; align-items: center; gap: 6px; }
        .modal-total { font-size: 1.5rem; font-weight: 800; color: #212529; text-align: right; margin-top: 15px; border-top: 2px solid #eee; padding-top: 15px;}
        .search-sticky { position: sticky; top: 0; z-index: 1000; background: #f0f2f5; padding: 10px 0; }
    </style>
</head>
<body>

<div id="adminPanel" class="admin-panel container">
    <h5>üõ†Ô∏è Configuraci√≥n (Repartidor)</h5>
    <div class="row g-2">
        <div class="col-4"><label class="small text-muted">WhatsApp</label><input type="number" id="adminPhone" class="form-control form-control-sm" placeholder="Ej: 549..." oninput="generarLink()"></div>
        <div class="col-4"><label class="small text-muted">Ganancia %</label><input type="number" id="adminMargin" class="form-control form-control-sm" value="0" placeholder="Ej: 20" oninput="actualizarPreciosEnVivo()"></div>
        <div class="col-4"><label class="small text-muted">Env√≠o $</label><input type="number" id="adminShipping" class="form-control form-control-sm" value="0" placeholder="Ej: 500" oninput="generarLink()"></div>
    </div>
    <div id="linkBox" class="share-link-box mt-3" style="display:none">
        <span class="text-warning">üëá Link para el Kiosquero:</span><br>
        <a id="generatedLink" href="#" target="_blank" class="text-white text-decoration-underline">Generando...</a>
        <button class="btn btn-sm btn-outline-light mt-2 w-100" onclick="copiarLink()">Copiar Link</button>
    </div>
</div>

<div class="container">
    <div id="shoppingTitle" class="mt-3 mb-2" style="display:none">
        <div class="d-flex justify-content-between align-items-center">
            <h3 class="fw-bold m-0">üìã Control de Pedido</h3>
            <span class="badge bg-primary">Modo Edici√≥n</span>
        </div>
        <p class="text-muted small mt-1">Toc√° para tachar. Us√° la lupa para agregar/reemplazar.</p>
    </div>

    <div class="search-sticky">
        <input type="text" id="searchInput" class="form-control border-0 py-2 shadow-sm rounded-pill" placeholder="üîç Buscar para agregar o reemplazar...">
    </div>
    <div id="productList">
        <div class="text-center mt-5 pt-5"><div class="spinner-border text-primary"></div><p class="mt-2 text-muted small">Cargando...</p></div>
    </div>
</div>

<div id="cartBar" class="cart-bar" onclick="abrirCarrito()">
    <div><div style="font-size: 0.75rem; opacity: 0.8"><span id="totalItems">0</span> √≠tems</div><div style="font-size: 1.2rem; font-weight: bold" id="totalPriceBar">$0</div></div>
    <button class="btn-ver-pedido"><i class="bi bi-cart-fill"></i> Ver Pedido</button>
</div>

<div class="modal fade" id="cartModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-dialog-scrollable"><div class="modal-content">
    <div class="modal-header border-0 pb-0"><h5 class="modal-title fw-bold">üõí Confirmar Pedido</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body font-monospace pt-0">
        <div id="cartItemsContainer" class="mt-3"></div>
        <div class="mt-3 p-2 bg-light rounded d-flex justify-content-between align-items-center small">
            <span class="text-muted">üõµ Env√≠o:</span>
            <input type="number" id="shippingCostInput" class="form-control form-control-sm bg-light text-end fw-bold" value="0" readonly style="width: 80px; border:none;">
        </div>
        <div class="modal-total">Total: <span id="modalFinalPrice">$0</span></div>
        <div class="text-center mt-2"><small class="text-muted fst-italic" style="font-size: 0.75rem">* Precios por peso son aproximados</small></div>
    </div>
    <div class="modal-footer border-0"><button type="button" class="btn btn-success w-100 fw-bold py-3 rounded-pill fs-5 shadow-sm" onclick="enviarWhatsapp()"><i class="bi bi-whatsapp"></i> REENVIAR PEDIDO ACTUALIZADO</button></div>
</div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // === CONFIG ===
    // Apunta al archivo local
    const SHEET_URL = "catalogo_completo.csv"; 
    // ==============

    let products = []; let cart = {}; let globalMargin = 0; let sellerPhone = ""; let shippingCost = 0; let rawCSV = "";
    let cartModalInstance = null; 
    let isShoppingMode = false; 

    window.onload = function() {
        cartModalInstance = new bootstrap.Modal(document.getElementById('cartModal'));
        const myModalEl = document.getElementById('cartModal');
        myModalEl.addEventListener('show.bs.modal', () => document.getElementById("cartBar").classList.remove("visible"));
        myModalEl.addEventListener('hidden.bs.modal', () => updateCartBar());

        const p = new URLSearchParams(window.location.search);
        
        // --- DETECCI√ìN DE MODO ---
        if (p.get('order')) {
            // MODO SHOPPING (REPARTIDOR)
            isShoppingMode = true;
            document.body.classList.add("shopping-mode");
            document.getElementById("shoppingTitle").style.display = "block";
            
            try {
                // FIX PARA M√ìVIL: decodeURIComponent para soportar tildes/emojis
                const orderData = JSON.parse(decodeURIComponent(atob(p.get('order')))); 
                cart = orderData; 
                sellerPhone = p.get('w') || ""; 
            } catch(e) { 
                console.error("Error al leer pedido", e);
                // Si falla, intentamos leer sin decode (por compatibilidad con links viejos si hubieran)
                try { cart = JSON.parse(atob(p.get('order'))); } catch(e2){}
            }
            
            cargarProductos(); 
            
        } else if (p.get('m') || p.get('w')) {
            // MODO KIOSQUERO
            globalMargin = parseFloat(p.get('m')) || 0; sellerPhone = p.get('w') || ""; shippingCost = parseFloat(p.get('s')) || 0;
            document.getElementById("adminPanel").style.display = "none";
            cargarProductos();
        } else {
            // MODO ADMIN
            document.body.classList.add("admin-mode");
            document.getElementById("adminPanel").style.display = "block";
            if(localStorage.getItem('myPhone')) document.getElementById('adminPhone').value = localStorage.getItem('myPhone');
            if(localStorage.getItem('myMargin')) {
                document.getElementById('adminMargin').value = localStorage.getItem('myMargin');
                globalMargin = parseFloat(localStorage.getItem('myMargin')) || 0;
            }
            if(localStorage.getItem('myShipping')) document.getElementById('adminShipping').value = localStorage.getItem('myShipping');
            generarLink();
            cargarProductos();
        }
        
        // BUSCADOR INTELIGENTE EN MODO SHOPPING
        document.getElementById("searchInput").addEventListener("input", function() {
            if (isShoppingMode) {
                if (this.value.trim() === "") {
                    renderShoppingList(); // Si borra, vuelve a la lista
                } else {
                    renderList(products); // Si escribe, muestra cat√°logo para agregar
                }
            } else {
                renderList(products);
            }
        });
    };

    function cargarProductos() {
        fetch(SHEET_URL).then(r => r.ok ? r.text() : Promise.reject(r.status)).then(csv => {
            rawCSV = csv; 
            products = parseCSV(csv); 
            
            if(isShoppingMode) {
                renderShoppingList(); 
            } else {
                renderList(products); 
            }
            
        }).catch(e => { console.error(e); document.getElementById("productList").innerHTML = `<div class="alert alert-danger text-center">Error cargando datos.</div>`; });
    }

    // --- RENDERIZADO MODO SHOPPING (LISTA PARA TACHAR) ---
    function renderShoppingList() {
        const container = document.getElementById("productList"); container.innerHTML = "";
        let grandTotal = 0;
        
        const cartKeys = Object.keys(cart);
        if (cartKeys.length === 0) {
            container.innerHTML = `<div class="text-center mt-5 text-muted"><h4>üóëÔ∏è Pedido Vac√≠o</h4><p>Us√° el buscador para agregar productos.</p></div>`;
            return;
        }

        for (let name in cart) {
            const prod = products.find(p => p.name === name);
            const price = prod ? prod.price : 0;
            const category = prod ? prod.category : "VARIOS";
            const qty = cart[name];
            const totalItem = price * qty;
            grandTotal += totalItem;

            const html = `
            <div class="product-card shopping-item" onclick="toggleStatus(this)">
                <div class="status-icon"><i class="bi bi-circle"></i></div>
                <div style="flex: 1;">
                    <div class="category-label">${category}</div>
                    <div class="product-name" style="font-size: 1.1rem">${name}</div>
                    <div class="text-muted">
                        <span class="fw-bold text-dark fs-5">${qty} un.</span> 
                        <span class="ms-2 small">x $${price.toLocaleString('es-AR')}</span>
                    </div>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <div class="fw-bold text-end me-2">$${totalItem.toLocaleString('es-AR')}</div>
                    <button class="btn-trash-shop" onclick="event.stopPropagation(); deleteItemInShop('${name}')"><i class="bi bi-trash3"></i></button>
                </div>
            </div>`;
            container.innerHTML += html;
        }
        
        container.innerHTML += `<div class="mt-4 p-3 bg-white rounded shadow-sm text-end fw-bold fs-4">Total: $${grandTotal.toLocaleString('es-AR')}</div>`;
        
        // Bot√≥n final
        container.innerHTML += `<div class="d-grid gap-2 mt-3 mb-5">
            <button onclick="enviarWhatsapp()" class="btn btn-primary btn-lg"><i class="bi bi-whatsapp"></i> Confirmar Cambios y Enviar</button>
        </div>`;
    }

    function toggleStatus(element) {
        const icon = element.querySelector(".status-icon i");
        if (element.classList.contains("status-done")) {
            element.classList.remove("status-done");
            element.classList.add("status-issue");
            icon.className = "bi bi-exclamation-triangle-fill text-warning";
        } else if (element.classList.contains("status-issue")) {
            element.classList.remove("status-issue");
            icon.className = "bi
